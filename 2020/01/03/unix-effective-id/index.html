<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>你是哪个宝可梦？进程运行时的ID研究 | 天然趣博客</title>
    <meta name="description" content="左趋趋的实验坊">
    
    
    <link rel="preload" href="/assets/css/0.styles.ab3a8e11.css" as="style"><link rel="preload" href="/assets/js/app.a0e0e95e.js" as="script"><link rel="preload" href="/assets/js/4.8c503eb6.js" as="script"><link rel="preload" href="/assets/js/5.87d5e368.js" as="script"><link rel="preload" href="/assets/js/10.2873ac63.js" as="script"><link rel="prefetch" href="/assets/js/1.812646ed.js"><link rel="prefetch" href="/assets/js/11.305a9091.js"><link rel="prefetch" href="/assets/js/12.f355aa28.js"><link rel="prefetch" href="/assets/js/13.9f7aefa1.js"><link rel="prefetch" href="/assets/js/14.38c33ecf.js"><link rel="prefetch" href="/assets/js/15.27baac88.js"><link rel="prefetch" href="/assets/js/6.6e35c55a.js"><link rel="prefetch" href="/assets/js/7.687a4f06.js"><link rel="prefetch" href="/assets/js/8.2cde32d0.js"><link rel="prefetch" href="/assets/js/9.fdb5e054.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.f823f1bf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab3a8e11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuperess-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">天然趣博客 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="/about/" class="nav-link">About</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">天然趣博客 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About</a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuperess-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="你是哪个宝可梦？进程运行时的id研究"><a href="#你是哪个宝可梦？进程运行时的id研究" class="header-anchor">#</a> 你是哪个宝可梦？进程运行时的ID研究</h1> <p><img src="/assets/img/pokemon.e795529f.jpeg" alt="pokemon"></p> <p>Unix 系统里的ID在运行的过程中，有三种不同的ID。首先是Real user ID（ruid），这个id是在<code>/etc/passwd</code>里出现的.</p> <div class="language-plain extra-class"><pre class="language-text"><code>cat /etc/passwd
...
phao:x:1000:1000:phao,,,:/home/phao:/bin/bash
...
</code></pre></div><p>这里可以看到我的用户id是1000，这就是real user id。</p> <p>第二个id是effective id，这个id是运行时的判断，apue书里举了一个例子。修改密码这个操作，需要的是root权限，但是每个用户也应当允许修改自己的密码，用户会调用passwd程序，修改好密码之后要对<code>/etc/passwd</code>或<code>/etc/shadow</code>进行修改，但是这两个文件的属主都是 root 用户， id = 0. 普通用户，比如id=1000的你（ruid），允许运行passwd程序，但是一般情况下，你运行的程序会说，运行我的是1000用户，当它要写文件的时候，也是以1000用户的身份去写的。它去写文件，没有权限，这个操作就失败了。</p> <p>显然，passwd就不能这样，它作为一个特殊程序，要代理你的操作，然后提权，才能把用户修改的新密码写入到系统文件里去。effective user id（euid），就是这个作用，进程操作资源的时候，检测的是euid，它可以不同于ruid。</p> <p>运行 ls，发现passwd有一个特殊的权限位 s，这个叫做set user id bit。</p> <div class="language-plain extra-class"><pre class="language-text"><code>phao@srazer:~$ l /usr/bin/passwd
-rwsr-xr-x 1 root root 59640 Mar 22  2019 /usr/bin/passwd*
</code></pre></div><p>这个s发生在了本来应该是x的地方（rwx），意思是当运行passwd程序的时候，进行set user id操作，这个操作就是把effective id设置为文件属主，我的用户id是1000（ruid）,但是这个文件的属主是0（root），那么我运行passwd，进程得到的euid是passwd文件的属主0，也即root用户，密码输入之后，euid为0的进程，去修改一个owner id为0的文件，是可以顺利操作的。</p> <p>我们也写一个类似passwd的程序，然后print(geteuid())，看看euid是不是真的变成了0。</p> <p>假设此程序叫做euid_test。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;ruid is : %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;euid is : %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>把它的owner设置成root，然后设置set uid位，运行即可观察：</p> <div class="language-plain extra-class"><pre class="language-text"><code>phao@srazer:~/p$ sudo chown root:root euid_test
phao@srazer:~/p$ sudo chmod +s euid_test
phao@srazer:~/p$ ls -l euid_test
-rwsr-sr-x 1 root root 8392 Jan  1 11:41 euid_test
phao@srazer:~/p$ ./euid_test
ruid is : 1000
euid is : 0
</code></pre></div><p>那么问题来了，binary如此，脚本程序也可以设置set uid big达到效果吗？答案是，不行，脚本程序不能通过设置set user id bit来进行euid的切换，是基于security的<a href="https://unix.stackexchange.com/questions/364/allow-setuid-on-shell-scripts?answertab=votes#tab-top" target="_blank" rel="noopener noreferrer">原因<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>设计成这样的。。</p> <p>我们用python脚本来尝试一下。</p> <div class="language-python extra-class"><pre class="language-python"><code>phao@srazer<span class="token punctuation">:</span><span class="token operator">~</span>$ cat euid_test<span class="token punctuation">.</span>py
<span class="token comment">#!/usr/bin/python3</span>
<span class="token keyword">import</span> os
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ruid is :&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;euid is :&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>geteuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

phao@srazer<span class="token punctuation">:</span><span class="token operator">~</span>$ ls <span class="token operator">-</span>l euid_test<span class="token punctuation">.</span>py
<span class="token operator">-</span>rwsr<span class="token operator">-</span>sr<span class="token operator">-</span>x <span class="token number">1</span> root root <span class="token number">94</span> Dec <span class="token number">31</span> <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">03</span> t<span class="token punctuation">.</span>py

phao@srazer<span class="token punctuation">:</span><span class="token operator">~</span>$ <span class="token punctuation">.</span><span class="token operator">/</span>euid_test<span class="token punctuation">.</span>py
uid<span class="token punctuation">:</span> <span class="token number">1000</span>
euid<span class="token punctuation">:</span> <span class="token number">1000</span>
</code></pre></div><p>如果我<a href="https://stackoverflow.com/questions/39913847/is-there-a-way-to-compile-python-application-into-static-binary" target="_blank" rel="noopener noreferrer">把这个python脚本编译成一个binary<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来运行呢？是的，和c编译出来的binary一样，可以成功切换euid。</p> <div class="language- extra-class"><pre class="language-text"><code>phao@srazer:~$ ls -l test
-rwsr-sr-x 1 root root 25856 Dec 31 17:57 test
phao@srazer:~$ ./test
('uid:', 1000)
('euid:', 0)
</code></pre></div><p>但是如果你需要在ruid和切换到的euid之间左右横跳呢？你写了一个程序，有时候是用root做一些操作，有时候又想用自己的身份，创建一个文件。系统调用seteuid允许你设置自己当前的effective id。</p> <p>比如上面的test程序，ruid=phao, 运行起来之后euid=root,然后我想以phao的身份创建一个文件，我可以在运行的过程中seteuid(1000), 来切换身份，文件操作结束之后，我继续用root的身份作威作福，可以seteuid(0).</p> <p>ruid是root的话，seteuid可以用来切换成任何用户。但是作为普通用户，seteuid随意切换成任意人的身份，肯定是受限的。所以当进程运行起来的时候，其实有第三个id，叫做saved set-user-id，它的意思是，这个进程运行起来的时候，由于程序binary文件有s bit，进行了euid的切换，我先给他存个这个euid的备份，一会进程切换身份的时候，就和我这个备份比一比，它的euid只允许在ruid和我这个saved set-user-id之间切换，不能随意切换成任意人的身份。</p> <p>当saved set-user-id是0的时候，即root的时候，ruid的普通用户其实也能切换成任意id了，因为你都有root的euid了，限制这个没有意义。</p> <p>但是当saved set-user-id是普通用户的时候，就真的只能在你们两个屌丝之间切换了。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>phao@srazer<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>p$ cat euid_switch<span class="token punctuation">.</span>c
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> uid<span class="token operator">=</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> euid<span class="token operator">=</span><span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;ruid is : %d\n&quot;</span><span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;euid is : %d\n&quot;</span><span class="token punctuation">,</span> euid<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">seteuid</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Set euid to ruid.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;euid: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">seteuid</span><span class="token punctuation">(</span>euid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Set euid to saved set-user-id.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;euid: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">seteuid</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Set euid to a uid=1.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;euid: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>phao@srazer<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>p$ gcc euid_switch<span class="token punctuation">.</span>c  <span class="token operator">-</span>o euid_switch<span class="token punctuation">;</span> sudo chown root<span class="token punctuation">:</span>root euid_switch<span class="token punctuation">;</span> sudo chmod <span class="token operator">+</span>s euid_switch 
phao@srazer<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>p$ <span class="token punctuation">.</span><span class="token operator">/</span>euid_switch 
ruid <span class="token keyword">is</span> <span class="token punctuation">:</span> <span class="token number">1000</span>
euid <span class="token keyword">is</span> <span class="token punctuation">:</span> <span class="token number">0</span>
Set euid to ruid<span class="token punctuation">.</span>
euid<span class="token punctuation">:</span> <span class="token number">1000</span>
Set euid to saved <span class="token builtin">set</span><span class="token operator">-</span>user<span class="token operator">-</span><span class="token builtin">id</span><span class="token punctuation">.</span>
euid<span class="token punctuation">:</span> <span class="token number">0</span>
Set euid to a uid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span>
euid<span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> 我ruid是<span class="token number">1000</span><span class="token punctuation">,</span> 因为有saved <span class="token builtin">set</span><span class="token operator">-</span>user<span class="token operator">-</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">0</span>罩着，我切成<span class="token number">1</span>也是可以的。
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>phao@srazer<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>p$ gcc euid_switch<span class="token punctuation">.</span>c  <span class="token operator">-</span>o euid_switch<span class="token punctuation">;</span> sudo chown solo<span class="token punctuation">:</span>solo euid_switch<span class="token punctuation">;</span> sudo chmod <span class="token operator">+</span>s euid_switch 
phao@srazer<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>p$ <span class="token punctuation">.</span><span class="token operator">/</span>euid_switch 
ruid <span class="token keyword">is</span> <span class="token punctuation">:</span> <span class="token number">1000</span>
euid <span class="token keyword">is</span> <span class="token punctuation">:</span> <span class="token number">1001</span>
Set euid to ruid<span class="token punctuation">.</span>
euid<span class="token punctuation">:</span> <span class="token number">1000</span>
Set euid to saved <span class="token builtin">set</span><span class="token operator">-</span>user<span class="token operator">-</span><span class="token builtin">id</span><span class="token punctuation">.</span>
euid<span class="token punctuation">:</span> <span class="token number">1001</span>
Set euid to a uid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span>
euid<span class="token punctuation">:</span> <span class="token number">1001</span>   <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> 我ruid是<span class="token number">1000</span><span class="token punctuation">,</span> saved <span class="token builtin">set</span><span class="token operator">-</span>user<span class="token operator">-</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1001</span>也是个屌丝，我切成<span class="token number">1</span>压根没用
</code></pre></div><p>太真实了，牛逼的朋友（root）借我一张身份卡，我可以切换成各种低级身份，而我上铺的兄弟，就只能和我自嗨。</p></div> <!----> <hr> <!----></div> <!----></div></div> <footer class="footer" data-v-97b6647a><div class="footer-left-wrap" data-v-97b6647a><ul class="contact" data-v-97b6647a></ul></div> <div class="footer-right-wrap" data-v-97b6647a><ul class="copyright" data-v-97b6647a></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a0e0e95e.js" defer></script><script src="/assets/js/4.8c503eb6.js" defer></script><script src="/assets/js/5.87d5e368.js" defer></script><script src="/assets/js/10.2873ac63.js" defer></script>
  </body>
</html>
